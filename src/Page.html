<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <link rel="stylesheet" href="https://ssl.gstatic.com/docs/script/css/add-ons1.css">
  </head>
  <body>
    <div class="sidebar">
      <div class="block">
        <label for="folderId">Enter folder ID:</label>
        <input type="text" id="folderId" class="width-100">
        <button onclick="getImages()" class="action">Get Images</button>
        <button id="stopButton" onclick="stopProcessing()" class="action" disabled>Stop Processing</button>
      </div>
      <div id="status" class="block"></div>
      <div id="progress" class="block"></div>
      <img id="currentImage" class="block" style="width: 100%;" />
    </div>
    <script>
      var stop = false;

      function getImages() {
        stop = false;
        document.getElementById('stopButton').disabled = false;
        var folderId = document.getElementById('folderId').value;
        document.getElementById('status').innerText = 'Fetching images...';
        google.script.run.withSuccessHandler(showImages).getImages(folderId);
      }

      function stopProcessing() {
        stop = true;
        document.getElementById('status').innerText = 'Stopped by user.';
        document.getElementById('progress').innerText = '';
        document.getElementById('currentImage').src = '';
        document.getElementById('stopButton').disabled = true;
      }

      function showImages(imageIds) {
        document.getElementById('status').innerText = imageIds.length + ' images found. Processing...';
        processImages(imageIds, 0);
      }

      function processImages(imageIds, index) {
        if (stop || index >= imageIds.length) {
          if (index >= imageIds.length) {
            document.getElementById('status').innerText = 'Done!';
            document.getElementById('progress').innerText = '';
            document.getElementById('currentImage').src = '';
          }
          document.getElementById('stopButton').disabled = true;
          return;
        }
        var imageId = imageIds[index];
        document.getElementById('progress').innerText = 'Processing image ' + (index + 1) + ' of ' + imageIds.length;
        document.getElementById('currentImage').src = 'https://drive.google.com/uc?export=view&id=' + imageId;
        google.script.run.withSuccessHandler(function() {
          processImages(imageIds, index + 1);
        }).createSlide(imageId);
      }
    </script>
  </body>
</html>
